---
- name: Display KubeVIP installation information
  ansible.builtin.debug:
    msg: "Installing KubeVIP {{ kubevip_version }} on {{ inventory_hostname }}"

- name: Create KubeVIP RBAC manifest
  ansible.builtin.copy:
    dest: /var/lib/rancher/k3s/server/manifests/kube-vip-rbac.yaml
    content: |
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: kube-vip
        namespace: kube-system
      ---
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        annotations:
          rbac.authorization.kubernetes.io/autoupdate: "true"
        name: system:kube-vip-role
      rules:
        - apiGroups: [""]
          resources: ["services/status"]
          verbs: ["update"]
        - apiGroups: [""]
          resources: ["services", "endpoints"]
          verbs: ["list","get","watch", "update"]
        - apiGroups: [""]
          resources: ["nodes"]
          verbs: ["list","get","watch", "update", "patch"]
        - apiGroups: ["coordination.k8s.io"]
          resources: ["leases"]
          verbs: ["list", "get", "watch", "update", "create"]
        - apiGroups: ["discovery.k8s.io"]
          resources: ["endpointslices"]
          verbs: ["list","get","watch", "update"]
      ---
      kind: ClusterRoleBinding
      apiVersion: rbac.authorization.k8s.io/v1
      metadata:
        name: system:kube-vip-binding
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: system:kube-vip-role
      subjects:
      - kind: ServiceAccount
        name: kube-vip
        namespace: kube-system
    mode: '0644'

- name: Wait for RBAC to be applied
  ansible.builtin.shell: |
    kubectl get serviceaccount kube-vip -n kube-system
  register: rbac_check
  until: rbac_check.rc == 0
  retries: 10
  delay: 5
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Create KubeVIP DaemonSet manifest
  ansible.builtin.copy:
    dest: /var/lib/rancher/k3s/server/manifests/kube-vip-ds.yaml
    content: |
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: kube-vip
        namespace: kube-system
        labels:
          app.kubernetes.io/name: kube-vip
          app.kubernetes.io/version: "{{ kubevip_version }}"
      spec:
        selector:
          matchLabels:
            app.kubernetes.io/name: kube-vip
        template:
          metadata:
            labels:
              app.kubernetes.io/name: kube-vip
              app.kubernetes.io/version: "{{ kubevip_version }}"
          spec:
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                  - matchExpressions:
                    - key: node-role.kubernetes.io/master
                      operator: Exists
                  - matchExpressions:
                    - key: node-role.kubernetes.io/control-plane
                      operator: Exists
            containers:
            - name: kube-vip
              image: {{ kubevip_image }}
              imagePullPolicy: IfNotPresent
              args:
              - manager
              env:
              - name: vip_arp
                value: "true"
              - name: port
                value: "6443"
              - name: vip_interface
                value: "{{ node_interface }}"
              - name: vip_cidr
                value: "32"
              - name: dns_mode
                value: "first"
              - name: cp_enable
                value: "true"
              - name: cp_namespace
                value: kube-system
              - name: svc_enable
                value: "false"
              - name: svc_leasename
                value: plndr-svcs-lock
              - name: vip_leaderelection
                value: "true"
              - name: vip_leasename
                value: plndr-cp-lock
              - name: vip_leaseduration
                value: "5"
              - name: vip_renewdeadline
                value: "3"
              - name: vip_retryperiod
                value: "1"
              - name: address
                value: "{{ kubevip_vip }}"
              - name: prometheus_server
                value: ":2112"
              securityContext:
                capabilities:
                  add:
                  - NET_ADMIN
                  - NET_RAW
            hostNetwork: true
            serviceAccountName: kube-vip
            tolerations:
            - effect: NoSchedule
              operator: Exists
            - effect: NoExecute
              operator: Exists
    mode: '0644'

- name: Wait for KubeVIP DaemonSet to be ready
  ansible.builtin.shell: |
    kubectl get daemonset kube-vip -n kube-system -o jsonpath='{.status.numberReady}'
  register: kubevip_ready
  until: kubevip_ready.stdout | int >= 1
  retries: 30
  delay: 10
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

- name: Wait for VIP to be active
  ansible.builtin.wait_for:
    host: "{{ kubevip_vip }}"
    port: 6443
    timeout: 120

# NOTE: Accept 401 as valid - newer K3s requires auth for /healthz
- name: Test API access via VIP
  ansible.builtin.uri:
    url: "https://{{ kubevip_vip }}:6443/healthz"
    validate_certs: no
    status_code: [200, 401]
  register: vip_health
  until: vip_health.status in [200, 401]
  retries: 10
  delay: 5

- name: VIP is active and responding
  ansible.builtin.debug:
    msg: "KubeVIP is active! VIP {{ kubevip_vip }} is responding on port 6443"
